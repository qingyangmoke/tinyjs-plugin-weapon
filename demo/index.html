<!DOCTYPE html>
<html lang="en">

<head>
  <title>荒野大作战</title>
  <meta charset="utf-8">
  <script src="libs/tiny.debug.js"></script>
  <script src="https://gw.alipayobjects.com/as/g/tiny-plugins/tinyjs-plugin-ant/0.0.5/index.debug.js"></script>
  <script src="https://a.alipayobjects.com/g/tiny-plugins/tinyjs-plugin-tiling/0.0.1/index.debug.js"></script>
  <script src="https://a.alipayobjects.com/g/tiny-plugins/tinyjs-plugin-keyboard/0.0.1/index.debug.js"></script>
  <script src="libs/dat.gui.min.js"></script>
  <script src="libs/stats.js"></script>
  <script src="libs/tinyjs-plugin-wordwrap.js"></script>
  <script src="../dist/index.debug.js"></script>
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=2,minimum-scale=1,user-scalable=1">
  <style type="text/css">
    body,
    html,
    canvas {
      padding: 0;
      margin: 0;
      -webkit-tap-highlight-color: rgba(0, 0, 0, 0)
    }
  </style>
</head>

<body>

  <script>
    var config = {
      showFPS: false, // 显示帧频
      dpi: 1, // 分辨率
      renderOptions: {
        backgroundColor: 0x2a3145 // 画布背景色
      }
    };

    var app = new Tiny.Application(config);

    // 启用物理系统
    Tiny.Physics.Ant.startSystem(app, {
      gravity: [0, 0],
      debug: {
        lineWidth: 1,
        alpha: 1,
        fill: false,
        fillColor: 0xff0000,
        lineColor: 0xff0000,
      }
    });

    function setTitle(title, container) {
      var title = new Tiny.Text(title, {
        fontSize: '18px',
        fill: 'white',
      });

      title.position.set(Tiny.WIN_SIZE.width / 2, 30);
      title.anchor.set(0.5, 0);
      container.addChild(title);
    }

    function createCircle(app, radius, color) {
      let graphics = new Tiny.Graphics();
      graphics.beginFill(color);
      graphics.drawCircle(radius, radius, radius);
      graphics.bounds = new Tiny.Rectangle(0, 0, radius * 2, radius * 2);
      var rt = Tiny.RenderTexture.create(radius * 2, radius * 2);
      app.renderer.render(graphics, rt);
      let sprite = new Tiny.Sprite(rt);
      return sprite;
    }

    function createBox(app, width, height, color) {
      let graphics = new Tiny.Graphics();
      graphics.beginFill(color);
      graphics.drawRect(0, 0, width, height);
      graphics.bounds = new Tiny.Rectangle(0, 0, width, height);
      var rt = Tiny.RenderTexture.create(width, height);
      app.renderer.render(graphics, rt);
      let sprite = new Tiny.Sprite(rt);
      return sprite;
    }

    function accelerationFromRotation(rotation, speed = 60, point) {
      point = point || new Tiny.Point();
      point.x = (Math.cos(rotation) * speed);
      point.y = (Math.sin(rotation) * speed);
      return point;
    }

    var sprite;
    function init() {
      container = new Tiny.Container();

      setTitle('荒野大作战', container);

      var tilingTexture = Tiny.Loader.resources['backgorund'].texture;
      var tilingSprite = new Tiny.tiling.TilingSprite(tilingTexture, Tiny.WIN_SIZE.width, Tiny.WIN_SIZE.height);
      container.addChild(tilingSprite);

      tilingSprite.tileScale.x = Tiny.WIN_SIZE.width / tilingTexture.width;

      sprite = new Tiny.Weapon.Bullet(Tiny.Loader.resources['player'].texture);

      sprite.position.x = Tiny.WIN_SIZE.width / 2;
      sprite.position.y = Tiny.WIN_SIZE.height - 100;
      sprite.anchor.set(0.5);

      app.physics.ant.enable(sprite, false);

      // sprite.body.collideWorldBounds = true;

      container.addChild(sprite);


      // border = createBox(app, sprite.width, sprite.height, 0xff0000);
      // border.position.x = -sprite.width / 2;
      // border.position.y = -sprite.height / 2;
      // border.alpha = 0.3;
      // sprite.addChild(border);

      // circle = createCircle(app, 4, 0x0000ff);
      // circle.position.x = -2;
      // circle.position.y = -2;
      // sprite.addChild(circle);

      // point = new Tiny.Weapon.Point(circle.position.x, circle.position.y);
      // point.set(sprite.x, sprite.y - sprite.height / 2);

      // circle = new Tiny.Sprite(Tiny.Loader.resources['bullet'].texture);
      // circle.position.x = point.x;
      // circle.position.y = point.y;
      // circle.anchor.set(0.5);

      // container.addChild(circle);

      weapon = new Tiny.Weapon.Emitter(app, Tiny.Loader.resources['bullet'].texture);
      // 子弹运行的速度
      weapon.bulletSpeed = 300;
      // 子弹发射的频率 两次发射不能低于这个数值
      weapon.fireRate = 300;
      // 是否自动发射
      weapon.autofire = true;

      // 根据时间销毁
      // weapon.bulletKillType = Tiny.Weapon.killTypes.KILL_LIFESPAN;
      // weapon.bulletLifespan = 500;

      // 根据距离销毁
      // weapon.bulletKillType = Tiny.Weapon.killTypes.KILL_DISTANCE;
      // weapon.bulletKillDistance = 50;
      weapon.trackSprite(sprite, 0, -sprite.height / 2, true, -90);

      container.addChild(weapon);

      app.run(container);

      var angle = 0;

      var leftArrow = new Tiny.Keyboard(37);
      var rightArrow = new Tiny.Keyboard(39);
      var upArrow = new Tiny.Keyboard(38);
      var downArrow = new Tiny.Keyboard(40);
      var spaceBar = new Tiny.Keyboard(32);

      var stats = initStats();
      app.onUpdate(function () {
        stats.update();

        tilingSprite.tilePosition.y += 5;

        if (upArrow.isDown || downArrow.isDown) {
          accelerationFromRotation(sprite.rotation - Math.PI / 2, downArrow.isDown ? -300 : 300, sprite.body.acceleration);
        } else {
          sprite.body.acceleration.set(0);
          sprite.body.velocity.set(0);
        }

        if (spaceBar.isDown) {
          weapon.fire();
        }

        if (leftArrow.isDown) {
          angle = (360 + angle - 3) % 360;
        } else if (rightArrow.isDown) {
          angle = (360 + angle + 3) % 360;
        }
        rotation(angle);

        Tiny.WorldWrap.wrap(app, sprite, 25);
      });


      var gui = new dat.GUI();

      var weaponConfig = {
        bulletKillType: ''
      };

      var killTypes = ["KILL_NEVER", "KILL_LIFESPAN", "KILL_DISTANCE", "KILL_WEAPON_BOUNDS", "KILL_CAMERA_BOUNDS", "KILL_WORLD_BOUNDS"];
      gui.add(weaponConfig, 'bulletKillType', killTypes).onChange(function () {
        weapon.bulletKillType = killTypes.indexOf(weaponConfig.bulletKillType);
      });

      gui.add(weapon, 'bulletLifespan', 100, 5000);
      gui.add(weapon, 'bulletKillDistance', 50, 500);
      gui.add(weapon, 'bulletSpeed', 0, 1000);
      gui.add(weapon, 'fireRate', 0, 600);
      gui.add(weapon, 'autofire');
    }



    function rotation(angle) {
      sprite.rotation = Tiny.Weapon.Math.degToRad(angle);
      // point.set(sprite.x, sprite.y - sprite.height / 2);
      // point.rotate(sprite.x, sprite.y, sprite.rotation);
      // circle.x = point.x;
      // circle.y = point.y;
    }



    function initStats() {
      var stats = new Stats();
      stats.setMode(0); // 0: fps, 1: ms
      // Align top-left
      stats.domElement.style.position = 'absolute';
      stats.domElement.style.left = '0px';
      stats.domElement.style.top = '0px';
      document.body.appendChild(stats.domElement);
      return stats;
    }

    initStats();

    Tiny.Loader
      .add('backgorund', 'images/desert-backgorund-looped.png')
      // .add('player', 'images/Spaceship_tut.png')
      // .add('player', 'images/ship1.png')
      // .add('player', 'images/ship2.png')
      .add('player', 'images/blue.png')
      .add('bullet', 'images/new_bullet.png')
      // .add('bullet', 'images/arrow.png')
      .load(function () {
        init();
      });
  </script>
</body>

</html>
