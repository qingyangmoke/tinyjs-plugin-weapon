/*!
 * Tiny.Weapon
 * Description:Tinyjs 的武器系统
 * Author: 清扬陌客 <qingyangmoke@qq.com>
 * Version: v0.0.1
 * Github: https://github.com/qingyangmoke/tinyjs-plugin-weapon.git
 */
!function(t,e){"object"==typeof exports&&"object"==typeof module?module.exports=e():"function"==typeof define&&define.amd?define([],e):"object"==typeof exports?exports.Weapon=e():(t.Tiny=t.Tiny||{},t.Tiny.Weapon=e())}(this,function(){return function(t){function e(r){if(i[r])return i[r].exports;var n=i[r]={exports:{},id:r,loaded:!1};return t[r].call(n.exports,n,n.exports,e),n.loaded=!0,n.exports}var i={};return e.m=t,e.c=i,e.p="/Users/song/Develop/github/tinyjs-plugin-weapon/dist",e(0)}([function(t,e,i){t.exports=i(1)},function(t,e,i){"use strict";function r(t){if(t&&t.__esModule)return t;var e={};if(null!=t)for(var i in t)Object.prototype.hasOwnProperty.call(t,i)&&(e[i]=t[i]);return e.default=t,e}function n(t){return t&&t.__esModule?t:{default:t}}Object.defineProperty(e,"__esModule",{value:!0}),e.killTypes=e.Emitter=e.Bullet=e.Rectangle=e.Point=e.Math=void 0;var o=i(2),a=n(o),s=i(4),l=n(s),u=i(5),h=n(u),f=i(3),c=r(f),p=i(7),d=n(p),y=i(6),_=r(y);e.Math=c,e.Point=a.default,e.Rectangle=l.default,e.Bullet=h.default,e.Emitter=d.default,e.killTypes=_},function(t,e,i){"use strict";function r(t){if(t&&t.__esModule)return t;var e={};if(null!=t)for(var i in t)Object.prototype.hasOwnProperty.call(t,i)&&(e[i]=t[i]);return e.default=t,e}function n(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function o(t,e){if(!t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!e||"object"!=typeof e&&"function"!=typeof e?t:e}function a(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function, not "+typeof e);t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,enumerable:!1,writable:!0,configurable:!0}}),e&&(Object.setPrototypeOf?Object.setPrototypeOf(t,e):t.__proto__=e)}Object.defineProperty(e,"__esModule",{value:!0});var s=function(){function t(t,e){for(var i=0;i<e.length;i++){var r=e[i];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(t,r.key,r)}}return function(e,i,r){return i&&t(e.prototype,i),r&&t(e,r),e}}(),l=i(3),u=r(l),h=function(t){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;return n(this,e),o(this,(e.__proto__||Object.getPrototypeOf(e)).call(this,t,i))}return a(e,t),s(e,[{key:"invert",value:function(){return this.setTo(this.y,this.x),this}},{key:"setTo",value:function(t,e){return this.set(t,e),this}},{key:"distance",value:function t(e,i){var r=this,n=e,t=u.distance(r.x,r.y,n.x,n.y);return i?Math.round(t):t}},{key:"isZero",value:function(){return 0===this.x&&0===this.y}},{key:"subtract",value:function(t,e){return this.x-=t,this.y-=e,this}},{key:"rotate",value:function(t,e,i,r,n){var o=this;if(r&&(i=u.degToRad(i)),void 0===n){o.subtract(t,e);var a=Math.sin(i),s=Math.cos(i),l=s*o.x-a*o.y,h=a*o.x+s*o.y;o.x=l+t,o.y=h+e}else{var f=i+Math.atan2(o.y-e,o.x-t);o.x=t+n*Math.cos(f),o.y=e+n*Math.sin(f)}return o}}]),e}(Tiny.Point);e.default=h},function(t,e){"use strict";function i(t,e){return e?this.wrap(t,-Math.PI,Math.PI):this.wrap(t,-180,180)}function r(t,e,i){var r=i-e;if(r<=0)return 0;var n=(t-e)%r;return n<0&&(n+=r),n+e}function n(t){return t*h}function o(t){return t*f}function a(t,e,i,r){var n=t-i,o=e-r;return Math.sqrt(n*n+o*o)}function s(t,e,i,r){return Math.atan2(r-e,i-t)}function l(t,e,i){return t<e?e:i<t?i:t}function u(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:1;if(t===e)return t;if(t<e){var i=t;t=e,e=i}return t=Math.ceil(t),e=Math.floor(e),Math.floor(Math.random()*(e-t+1))+t}Object.defineProperty(e,"__esModule",{value:!0}),e.wrapAngle=i,e.wrap=r,e.degToRad=n,e.radToDeg=o,e.distance=a,e.angle=s,e.clamp=l,e.between=u;var h=Math.PI/180,f=180/Math.PI},function(t,e){"use strict";function i(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function r(t,e){if(!t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!e||"object"!=typeof e&&"function"!=typeof e?t:e}function n(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function, not "+typeof e);t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,enumerable:!1,writable:!0,configurable:!0}}),e&&(Object.setPrototypeOf?Object.setPrototypeOf(t,e):t.__proto__=e)}Object.defineProperty(e,"__esModule",{value:!0});var o=function(){function t(t,e){for(var i=0;i<e.length;i++){var r=e[i];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(t,r.key,r)}}return function(e,i,r){return i&&t(e.prototype,i),r&&t(e,r),e}}(),a=function(t){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,o=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,a=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0;return i(this,e),r(this,(e.__proto__||Object.getPrototypeOf(e)).call(this,t,n,o,a))}return n(e,t),o(e,[{key:"centerOn",value:function(t,e){return this.centerX=t,this.centerY=e,this}},{key:"halfWidth",get:function(){return this.width/2}},{key:"halfHeight",get:function(){this.x=this.height/2}},{key:"centerX",get:function(){return this.x+this.halfWidth},set:function(t){this.x=t-this.halfWidth}},{key:"centerY",get:function(){return this.y+this.halfHeight},set:function(t){this.y=t-this.halfHeight}},{key:"randomX",get:function(){return this.x+Math.random()*this.width}},{key:"randomY",get:function(){return this.y+Math.random()*this.height}}]),e}(Tiny.Rectangle);e.default=a},function(t,e,i){"use strict";function r(t){if(t&&t.__esModule)return t;var e={};if(null!=t)for(var i in t)Object.prototype.hasOwnProperty.call(t,i)&&(e[i]=t[i]);return e.default=t,e}function n(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function o(t,e){if(!t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!e||"object"!=typeof e&&"function"!=typeof e?t:e}function a(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function, not "+typeof e);t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,enumerable:!1,writable:!0,configurable:!0}}),e&&(Object.setPrototypeOf?Object.setPrototypeOf(t,e):t.__proto__=e)}Object.defineProperty(e,"__esModule",{value:!0});var s=function(){function t(t,e){for(var i=0;i<e.length;i++){var r=e[i];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(t,r.key,r)}}return function(e,i,r){return i&&t(e.prototype,i),r&&t(e,r),e}}(),l=i(3),u=r(l),h=i(6),f=r(h),c=function(t){function e(t,i){n(this,e);var r=o(this,(e.__proto__||Object.getPrototypeOf(e)).call(this,t));return r._baseTexture=t,r.anchor.set(.5),r.data={emitter:i,fromX:0,fromY:0,fireTime:0,rotateToVelocity:!1,killType:0,killDistance:0,killLifeSpan:0},r._exists=!0,r._alive=!0,r}return a(e,t),s(e,[{key:"kill",value:function(){return this._alive=!1,this._exists=!1,this.visible=!1,this.dispatch("kill",this),console.log("kill"),this.parent&&(this.data.emitter.removeChild(this),this.parent=null),this}},{key:"dispatch",value:function(t){for(var e=arguments.length,i=Array(e>1?e-1:0),r=1;r<e;r++)i[r-1]=arguments[r];this.emit.apply(this,arguments)}},{key:"revive",value:function(){this._alive=!0,this._exists=!0,this.visible=!0,this.parent||this.data.emitter.addChild(this),this.dispatch("revive",this)}},{key:"update",value:function(){this.exists&&(this.data.killType===f.KILL_LIFESPAN?this.data.emitter.timeNow-this.data.fireTime>this.data.killLifeSpan&&this.kill():this.data.killType===f.KILL_DISTANCE?u.distance(this.x,this.y,this.data.fromX,this.data.fromY,!0)>this.data.killDistance&&this.kill():this.data.emitter.bulletBounds.contains(this.x,this.y)||this.kill(),this.data.rotateToVelocity&&(this.rotation=Math.atan2(this.body.velocity.y,this.body.velocity.x)))}},{key:"reset",value:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;this.x=t,this.y=e,this.rotation=i}},{key:"clone",value:function(){return new e(this._baseTexture,this.data.emitter)}},{key:"exists",get:function(){return this._exists},set:function(t){return this._exists}},{key:"alive",get:function(){return this._alive}}]),e}(Tiny.Sprite);e.default=c},function(t,e){"use strict";Object.defineProperty(e,"__esModule",{value:!0});e.KILL_NEVER=0,e.KILL_LIFESPAN=1,e.KILL_DISTANCE=2,e.KILL_WEAPON_BOUNDS=3,e.KILL_CAMERA_BOUNDS=4,e.KILL_WORLD_BOUNDS=5},function(t,e,i){"use strict";function r(t){if(t&&t.__esModule)return t;var e={};if(null!=t)for(var i in t)Object.prototype.hasOwnProperty.call(t,i)&&(e[i]=t[i]);return e.default=t,e}function n(t){return t&&t.__esModule?t:{default:t}}function o(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function a(t,e){if(!t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!e||"object"!=typeof e&&"function"!=typeof e?t:e}function s(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function, not "+typeof e);t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,enumerable:!1,writable:!0,configurable:!0}}),e&&(Object.setPrototypeOf?Object.setPrototypeOf(t,e):t.__proto__=e)}Object.defineProperty(e,"__esModule",{value:!0});var l=function(){function t(t,e){for(var i=0;i<e.length;i++){var r=e[i];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(t,r.key,r)}}return function(e,i,r){return i&&t(e.prototype,i),r&&t(e,r),e}}(),u=i(5),h=n(u),f=i(3),c=r(f),p=i(2),d=n(p),y=i(4),_=n(y),b=i(8),v=n(b),k=i(6),g=r(k),m=function(t){function e(t,i){o(this,e);var r=a(this,(e.__proto__||Object.getPrototypeOf(e)).call(this));return r.DEFAULT_KEY="default",r.app=t,r._fireCount=0,r._physics=r.app.physics.ant||r.app.physics.p2,r._bulletsPools={},r._bullets=[],r.trackedSprite=null,r.trackRotation=!0,r.trackOffset=new d.default(0,0),r._rotatedPoint=new d.default(0,0),r._fireFrom=new _.default(0,0,1,1),r.bulletSpeed=200,r.bulletSpeedVariance=0,r.bulletAngleOffset=0,r._bulletKillType=g.KILL_WORLD_BOUNDS,r.bulletBounds=r.getWorldBounds(),r.bulletAngleVariance=0,r.bulletGravity=new d.default(0,0),r.bulletLifespan=5e3,r.bulletKillDistance=100,r.bulletRotateToVelocity=!1,r.autofire=!1,r.fireLimit=0,r.fireAngle=0,r.fireRate=100,r.fireRateVariance=0,i&&r.register(i),r._ticker=new Tiny.ticker.Ticker,r._ticker.add(r.update,r),r._ticker.start(),r}return s(e,t),l(e,[{key:"getWorldBounds",value:function(){return new _.default(0,0,this.app.renderer.width,this.app.renderer.height)}},{key:"register",value:function(t,e){void 0===e&&(e=this.DEFAULT_KEY),e in this._bulletsPools||(this._bulletsPools[e]=new v.default(new h.default(t,this)))}},{key:"fire",value:function(t){if(null==this.trackedSprite)throw Error("trackedSprite is null");var e=this.timeNow;if(e<this._nextFire||this.fireLimit>0&&this.fireCount>=this.fireLimit)return!1;if(void 0===t&&(t=this.DEFAULT_KEY),!(t in this._bulletsPools))throw Error("please register first");var i=this._bulletsPools[t].getOne();this._bullets.push(i),this._physics.enable(i,!1),this.trackRotation?(this._rotatedPoint.set(this.trackedSprite.x+this.trackOffset.x,this.trackedSprite.y+this.trackOffset.y),this._rotatedPoint.rotate(this.trackedSprite.x,this.trackedSprite.y,this.trackedSprite.rotation),this._fireFrom.width>1?this._fireFrom.centerOn(this._rotatedPoint.x,this._rotatedPoint.y):(this._fireFrom.x=this._rotatedPoint.x,this._fireFrom.y=this._rotatedPoint.y)):this._fireFrom.width>1?this._fireFrom.centerOn(this.trackedSprite.x+this.trackOffset.x,this.trackedSprite.y+this.trackOffset.y):(this._fireFrom.x=this.trackedSprite.x+this.trackOffset.x,this._fireFrom.y=this.trackedSprite.y+this.trackOffset.y);var r=this.bulletSpeed;0!==this.bulletSpeedVariance&&(r+=c.between(-this.bulletSpeedVariance,this.bulletSpeedVariance));var n=this._fireFrom.width>1?this._fireFrom.randomX:this._fireFrom.x,o=this._fireFrom.height>1?this._fireFrom.randomY:this._fireFrom.y,a=this.trackedSprite.rotation+c.degToRad(this.fireAngle);0!==this.bulletAngleVariance&&(a+=c.degToRad(c.between(-this.bulletAngleVariance,this.bulletAngleVariance)));var s=0,l=0;if(0===a||180===a?s=Math.cos(a)*r:90===a||270===a?l=Math.sin(a)*r:(s=Math.cos(a)*r,l=Math.sin(a)*r),i.reset(n,o,a+this.bulletAngleOffset),i.data.fromX=n,i.data.fromY=o,i.data.fireTime=e,i.data.killType=this.bulletKillType,i.data.killDistance=this.bulletKillDistance,i.data.killLifeSpan=this.bulletLifespan,i.data.rotateToVelocity=this.bulletRotateToVelocity,!i.body)throw Error("set ant physics system first");i.body.velocity.x=s,i.body.velocity.y=l,i.body.gravity&&i.body.gravity.set(this.bulletGravity.x,this.bulletGravity.y);var u=this.fireRate;0!==this.fireRateVariance&&(u+=c.between(-this.fireRateVariance,this.fireRateVariance),u<0&&(u=0)),this._nextFire=e+u,this._fireCount++,this.dispatch("fire",i,this,r),this.fireLimit>0&&this.fireCount===this.fireLimit&&this.dispatch("fireLimit",this,this.fireLimit),i.parent!==this&&this.addChild(i),i.revive()}},{key:"dispatch",value:function(t){for(var e=arguments.length,i=Array(e>1?e-1:0),r=1;r<e;r++)i[r-1]=arguments[r];this.emit.apply(this,arguments)}},{key:"trackSprite",value:function(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,r=!(arguments.length>3&&void 0!==arguments[3])||arguments[3],n=arguments.length>4&&void 0!==arguments[4]?arguments[4]:0;return this.trackedSprite=t,this.trackRotation=r,this.trackOffset.set(e,i),this.fireAngle=n,this}},{key:"update",value:function(){var t=this,e=[];this._bullets.forEach(function(t,i){t.update(),t.exists||e.push(t)}),e.forEach(function(e){var i=t._bullets.indexOf(e);t._bullets.splice(i,1)}),e=null,this.autofire&&this.fire()}},{key:"destroy",value:function(){this._ticker.remove(this.update,this),this._ticker.stop(),this._physics=null,this.app=null,this._bulletsPools=null,this._bullets=null}},{key:"bulletKillType",get:function(){return this._bulletKillType},set:function(t){switch(t){case g.KILL_CAMERA_BOUNDS:case g.KILL_WORLD_BOUNDS:this.bulletBounds=this.getWorldBounds()}this._bulletKillType=t}},{key:"timeNow",get:function(){return Date.now()}},{key:"fireCount",get:function(){return this._fireCount}}]),e}(Tiny.Container);e.default=m},function(t,e){"use strict";function i(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(e,"__esModule",{value:!0});var r=function(){function t(t,e){for(var i=0;i<e.length;i++){var r=e[i];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(t,r.key,r)}}return function(e,i,r){return i&&t(e.prototype,i),r&&t(e,r),e}}(),n=function(){function t(e){i(this,t),this._bulletCreator=e,this._pool=[]}return r(t,[{key:"isEmpty",value:function(){return 0===this.size}},{key:"getOne",value:function(){return this.isEmpty?this._bulletCreator.clone():this._pool.shift()}},{key:"pushOne",value:function(t){this._pool.push(t)}},{key:"size",get:function(){return this._pool.length}}]),t}();e.default=n}])});